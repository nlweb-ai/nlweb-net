# TODO

This repo is a proof of concept ASP.NET Core implementation of the NLWeb standard / protocol as defined in <https://github.com/microsoft/NLWeb/>

## NLWeb Rest API

The REST API as copied from the source repo is as follows:

At this point, NLWeb supports 2 APIs at the endpoints /ask and /mcp. The arguments are the same for both, as is most of the functionality. The /mcp endpoint returns the answers in format that MCP clients can use. The /mcp endpoint also supports the core MCP methods (`list_tools`, `list_prompts`, `call_tool` and `get_prompt`).

In the included implementation, there is no server side state. So, the context of the conversation thus far has to be passed back as part of the request. As described below, there are multiple ways to do this.

The required argument to ask / mcp is:

- `query`: The current query in natural language

The following are optional arguments:

- `site`: A token corresponding to some subset of the data of a backend. For example, a backend might support multiple sites, each with a conversational interface restricted to its content. This parameter can be used to specify the site
- `prev`: comma separated list of previous queries. In most cases, the decontextualized query can be constructed from this.
- `decontextualized_query`: the entire decontextualized query. If this is available, no decontextualization is done on the server side
- `streaming`: defaults to true. To turn off streaming, specify a value of 0 or false
- `query_id`: if none is specified, one will be auto generated
- `mode`: values are list (default), summarize and generate
  - `list` : returns the list of top matches from the backend that are most relevant to the query
  - `summarize`: summarizes the list and presents the summary and also returns the list
  - `generate`: much more like traditional RAG, where the list is generated and one or more calls are made to an LLM to try answer the user's question.

The returned value is a json object with the following fields:

- `query_id`
- zero or more result attributes
- An array (soon to be moved to a richer structure, starting with schema.org's ItemList) of results, each of which has:
  - `url`
  - `name`
  - `site`
  - `score`
  - `description` (generated by an llm)
  - `schema_object` (the item, from the data store, encoded in json)

## Current Status

The demo application is now fully functional with a modern .NET 9 Blazor Web App structure. The application builds successfully, runs at `http://localhost:5037`, and provides a working foundation for NLWeb protocol implementation.

**Recent Additions:**

- ✅ **CI/CD Pipeline**: GitHub Actions workflow for automated builds, testing, code quality checks, security scanning, and NuGet package validation
- ✅ **Core Data Models**: Complete implementation of NLWeb protocol request/response models with validation and JSON serialization
- ✅ **Build Fixes**: Resolved App.razor build warnings by adding proper @using directives and removing duplicate files
- ✅ **CI/CD Testing Fix**: Updated GitHub Actions workflow to gracefully handle missing test projects and prevent build failures

The next phase focuses on implementing the core NLWeb library functionality.

## Implementation Plan

### Phase 1: Library Project Setup & Dependencies

- [x] Configure library project structure in `/src/NLWebNet/`:
  - [x] Create `NLWebNet.csproj` with NuGet package metadata
  - [x] Set up project references and dependencies
  - [x] Add necessary NuGet packages:
    - [x] `Microsoft.Extensions.AI` (for AI integration)
    - [x] `Microsoft.AspNetCore.Http.Abstractions` (for HTTP context)
    - [x] `Microsoft.Extensions.DependencyInjection.Abstractions` (for DI)
    - [x] `Microsoft.Extensions.Logging.Abstractions` (for logging)
    - [x] `Microsoft.Extensions.Options` (for configuration)
    - [x] `ModelContextProtocol` (official MCP SDK)
- [x] Configure demo project structure in `/demo/`:
  - [x] Create modern .NET 9 Blazor Web App with NLWebNet library reference
  - [x] Add Microsoft.AspNetCore.OpenApi for API documentation (.NET 9 style)
  - [x] Modernize from legacy Blazor Server to .NET 9 Blazor Web App structure
  - [x] Update Components structure (App.razor, _Imports.razor, Routes.razor)
  - [x] Move pages to Components/Pages/ and update layouts
  - [x] Update Program.cs to use AddRazorComponents and AddInteractiveServerComponents
  - [x] Remove legacy Razor Pages and update asset references (site.css → app.css)  - [x] Fix namespace and compilation issues
  - [x] Set up configuration for external services (API keys, endpoints)

### Phase 2: Core Data Models (Library)

- [x] Create library structure in `/src/NLWebNet/`:
  - [x] `Models/` directory for request/response models
  - [x] `Services/` directory for business logic interfaces
  - [x] `Extensions/` directory for DI extensions
  - [x] `Middleware/` directory for ASP.NET Core middleware
  - [x] `Controllers/` directory for API controllers
  - [x] `MCP/` directory for MCP integration
- [x] Implement request/response models:
  - [x] `NLWebRequest` class with properties: `query`, `site`, `prev`, `decontextualized_query`, `streaming`, `query_id`, `mode`
  - [x] `NLWebResponse` class with properties: `query_id`, result attributes, results array
  - [x] `NLWebResult` class with properties: `url`, `name`, `site`, `score`, `description`, `schema_object`
  - [x] `QueryMode` enum: `List`, `Summarize`, `Generate`
  - [x] `NLWebOptions` configuration class
- [x] Add proper validation attributes and JSON serialization settings
- [x] Set up CI/CD pipeline:
  - [x] GitHub Actions workflow for automated builds and testing
  - [x] Multi-configuration builds (Debug/Release)
  - [x] Code quality checks and formatting validation
  - [x] Security scanning for vulnerable packages
  - [x] NuGet package creation and validation
  - [x] Build status badge in README

### Phase 3: Business Logic Layer (Library)

- [ ] Implement core service interfaces and classes:
  - [ ] `INLWebService` interface for main business logic
  - [ ] `NLWebService` implementation
  - [ ] `IQueryProcessor` interface for query processing
  - [ ] `QueryProcessor` implementation for decontextualization
  - [ ] `IResultGenerator` interface for different modes (list, summarize, generate)
  - [ ] `ResultGenerator` implementation using AI services
  - [ ] `IDataBackend` interface for pluggable data sources
  - [ ] `MockDataBackend` implementation for testing/demo
- [ ] **OPEN QUESTION**: What backend data source will be used for search/retrieval?
- [ ] **OPEN QUESTION**: Which LLM service integration (Azure OpenAI, OpenAI, etc.)?

### Phase 4: MCP Integration (Library)

- [ ] Implement MCP core methods in `/src/NLWebNet/MCP/`:
  - [ ] `IMcpService` interface
  - [ ] `McpService` implementation
  - [ ] `list_tools` endpoint handler
  - [ ] `list_prompts` endpoint handler  
  - [ ] `call_tool` endpoint handler
  - [ ] `get_prompt` endpoint handler
- [ ] Create MCP-specific response formatters
- [ ] **OPEN QUESTION**: What tools and prompts should be exposed via MCP?

### Phase 5: API Controllers & Middleware (Library)

- [ ] Implement API controllers in `/src/NLWebNet/Controllers/`:
  - [ ] `AskController` for `/ask` endpoint
  - [ ] `McpController` for `/mcp` endpoint
  - [ ] Support for both GET and POST methods
  - [ ] Implement streaming response support (Server-Sent Events)
  - [ ] Add proper error handling and status codes
  - [ ] Add request validation and sanitization
- [ ] Implement custom middleware in `/src/NLWebNet/Middleware/`:
  - [ ] `NLWebMiddleware` for request processing
  - [ ] Query ID generation middleware (if not provided)
  - [ ] Response formatting middleware
  - [ ] Error handling middleware for NLWeb-specific errors

### Phase 6: Dependency Injection Extensions (Library)

- [ ] Create extension methods in `/src/NLWebNet/Extensions/`:
  - [ ] `ServiceCollectionExtensions.AddNLWebNet()` method
  - [ ] `ApplicationBuilderExtensions.MapNLWebNet()` method
  - [ ] Configuration binding for `NLWebOptions`
  - [ ] Service registration for all NLWebNet services
- [ ] Support for configuration callbacks and customization

### Phase 7: Demo Application Development

- [x] Updated demo Blazor app structure in `/demo/` to .NET 9 standards:
  - [x] Modernized Components/ structure with proper organization
  - [x] Updated Layout components (MainLayout.razor) to match .NET 9 patterns
  - [x] Moved and updated page components (Home.razor, NLWebDemo.razor, Error.razor)
  - [x] Updated Program.cs for modern Blazor Web App configuration
  - [x] Cleaned up legacy files and references
- [ ] Create enhanced Blazor components for NLWeb interface:
  - [ ] Query input component
  - [ ] Results display component
  - [ ] Mode selection component
  - [ ] Streaming response display
- [ ] Create additional demo pages:
  - [ ] Interactive NLWeb query page
  - [ ] API testing page
  - [ ] MCP endpoint demonstration
- [ ] Style with modern UI framework (Bootstrap/Fluent UI)
- [ ] Configure demo-specific settings:
  - [ ] Sample data backend configuration
  - [ ] AI service integration (if available)
  - [ ] Logging and diagnostics

### Phase 8: Configuration & Settings

- [ ] Library configuration support:
  - [ ] Strongly-typed `NLWebOptions` class
  - [ ] Support for multiple data backends
  - [ ] AI service configuration options
  - [ ] Default behavior settings
- [ ] Demo app configuration in `/demo/appsettings.json`:
  - [ ] NLWebNet library settings
  - [ ] AI service configuration (API keys, endpoints)
  - [ ] Logging configuration
  - [ ] CORS settings for cross-origin requests
- [ ] **OPEN QUESTION**: What external services need configuration?

### Phase 9: Testing & Validation

- [ ] Create test project (`/tests/NLWebNet.Tests/`)
- [ ] Unit tests for library:
  - [ ] Request/response model validation
  - [ ] Service layer logic
  - [ ] MCP method implementations
  - [ ] Query processing logic
  - [ ] Middleware functionality
- [ ] Integration tests:
  - [ ] `/ask` endpoint with different modes
  - [ ] `/mcp` endpoint functionality
  - [ ] Streaming response behavior
  - [ ] End-to-end demo app testing
- [ ] Create sample requests for manual testing

### Phase 10: Documentation & Packaging

- [ ] Library documentation:
  - [ ] XML documentation comments for all public APIs
  - [x] README with usage examples, architecture diagrams, and project overview
  - [ ] NuGet package description and tags
- [ ] Demo documentation:
  - [ ] Setup and running instructions
  - [ ] Configuration examples
  - [ ] API usage demonstrations
- [ ] Create NuGet package:
  - [ ] Configure package metadata
  - [ ] Test package installation
  - [ ] Publish to NuGet.org (when ready)

### Phase 11: Deployment & Production Readiness

- [ ] Library production features:
  - [ ] Health check integration
  - [ ] Performance monitoring hooks
  - [ ] Rate limiting support
  - [ ] Security best practices
- [ ] Demo app deployment:
  - [ ] Docker containerization
  - [ ] Azure App Service deployment configuration
  - [ ] Environment-specific configurations
- [ ] **OPEN QUESTION**: What are the deployment target requirements?

### Open Questions to Resolve

1. **Backend Data Source**: What will serve as the data backend for search/retrieval? (database, search index, external API?)
2. **LLM Integration**: Which AI service should be integrated? (Azure OpenAI, OpenAI API, local models?)
3. **Authentication**: Does the API need authentication/authorization?
4. **Deployment Target**: Where will this be deployed? (Azure, on-premises, containers?)
5. **Data Schema**: What format should the `schema_object` field follow?
6. **Streaming Implementation**: Should use Server-Sent Events (SSE) or WebSockets for streaming?
7. **NuGet Package Name**: Should we use "NLWebNet" or something else for the package name?
